(self.webpackChunktech_blog=self.webpackChunktech_blog||[]).push([[8511],{5301:function(e,t,a){e.exports={src:{srcSet:a.p+"assets/ideal-img/kickoff.9ab6f7f.640.jpg 640w,"+a.p+"assets/ideal-img/kickoff.968b8e0.770.jpg 770w,"+a.p+"assets/ideal-img/kickoff.ec04566.900.jpg 900w,"+a.p+"assets/ideal-img/kickoff.caab91a.1030.jpg 1030w",images:[{path:a.p+"assets/ideal-img/kickoff.9ab6f7f.640.jpg",width:640,height:386},{path:a.p+"assets/ideal-img/kickoff.968b8e0.770.jpg",width:770,height:464},{path:a.p+"assets/ideal-img/kickoff.ec04566.900.jpg",width:900,height:543},{path:a.p+"assets/ideal-img/kickoff.caab91a.1030.jpg",width:1030,height:621}],src:a.p+"assets/ideal-img/kickoff.9ab6f7f.640.jpg",toString:function(){return a.p+"assets/ideal-img/kickoff.9ab6f7f.640.jpg"},placeholder:void 0,width:640,height:386},preSrc:"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAGAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUG/8QAHhAAAQMFAQEAAAAAAAAAAAAAAQIDBAAFBhEhQXH/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/EABYRAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEQMRAD8A1Oa3W82thuRCnlttUkaISkKDRJJQRog8555V2DnF3bgx0OtQ3XEtpCnFI6s66T9pSkXT/9k=",palette:null}},2458:function(e,t,a){e.exports={src:{srcSet:a.p+"assets/ideal-img/launched.6785255.640.jpg 640w,"+a.p+"assets/ideal-img/launched.7e33653.770.jpg 770w,"+a.p+"assets/ideal-img/launched.f0cb8fd.900.jpg 900w,"+a.p+"assets/ideal-img/launched.cbd2621.1030.jpg 1030w",images:[{path:a.p+"assets/ideal-img/launched.6785255.640.jpg",width:640,height:303},{path:a.p+"assets/ideal-img/launched.7e33653.770.jpg",width:770,height:365},{path:a.p+"assets/ideal-img/launched.f0cb8fd.900.jpg",width:900,height:426},{path:a.p+"assets/ideal-img/launched.cbd2621.1030.jpg",width:1030,height:488}],src:a.p+"assets/ideal-img/launched.6785255.640.jpg",toString:function(){return a.p+"assets/ideal-img/launched.6785255.640.jpg"},placeholder:void 0,width:640,height:303},preSrc:"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAFAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUH/8QAJBAAAQIFAgcAAAAAAAAAAAAAAQIEAAMFERIHIQYTIjFRYXL/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAv/EABYRAQEBAAAAAAAAAAAAAAAAAAEAIf/aAAwDAQACEQMRAD8Ah1/UqsUitMWTfFTZOMqagkDm2PUokC4KrjsdrHzGgt9YwJEsDh2QBiNg49fEIRSaw0v/2Q==",palette:null}},7471:function(e,t,a){e.exports={src:{srcSet:a.p+"assets/ideal-img/maintainer.7631809.640.jpg 640w,"+a.p+"assets/ideal-img/maintainer.b1baed6.770.jpg 770w,"+a.p+"assets/ideal-img/maintainer.26c3518.900.jpg 900w,"+a.p+"assets/ideal-img/maintainer.b70cf28.1030.jpg 1030w",images:[{path:a.p+"assets/ideal-img/maintainer.7631809.640.jpg",width:640,height:427},{path:a.p+"assets/ideal-img/maintainer.b1baed6.770.jpg",width:770,height:513},{path:a.p+"assets/ideal-img/maintainer.26c3518.900.jpg",width:900,height:600},{path:a.p+"assets/ideal-img/maintainer.b70cf28.1030.jpg",width:1030,height:687}],src:a.p+"assets/ideal-img/maintainer.7631809.640.jpg",toString:function(){return a.p+"assets/ideal-img/maintainer.7631809.640.jpg"},placeholder:void 0,width:640,height:427},preSrc:"data:image/jpeg;base64,/9j/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wAARCAAHAAoDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAUG/8QAIBAAAgEEAQUAAAAAAAAAAAAAAQIDAAQFBhEUIjFBcf/EABUBAQEAAAAAAAAAAAAAAAAAAAID/8QAFhEBAQEAAAAAAAAAAAAAAAAAAQAh/9oADAMBAAIRAxEAPwC5mtuyFnsGViFnbjG2E3LMkjB+nB73+hfQ8mtna7Bqs9tDMlvJIkiBw7GQFgRzyRSlUTYjl//Z",palette:null}},7126:function(e,t,a){e.exports={src:{srcSet:a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.99d67ec.640.png 640w,"+a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.1bcc109.770.png 770w,"+a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.04fc6a5.900.png 900w,"+a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.0d4a84d.1030.png 1030w",images:[{path:a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.99d67ec.640.png",width:640,height:190},{path:a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.1bcc109.770.png",width:770,height:229},{path:a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.04fc6a5.900.png",width:900,height:268},{path:a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.0d4a84d.1030.png",width:1030,height:306}],src:a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.99d67ec.640.png",toString:function(){return a.p+"assets/ideal-img/wechaty-puppet-whatsapp-w.99d67ec.640.png"},placeholder:void 0,width:640,height:190},preSrc:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAoAAAADCAYAAACqPZ51AAAACXBIWXMAAC4jAAAuIwF4pT92AAAAeklEQVQImV3BsQqCQBzA4XuN3sC5d+sJosmpN+hWwdFBDo2GEMmplqYOKqngf5E45HXIz73vUz54iluB+zr++fGHDG/CGFDmaojSiLiKqbc15a4kNznN/sDqtGaWzdnYBGU/Fn3WtF1L3/WIE0SE1+OJviQsjkvSe8YEW4dm1po58RMAAAAASUVORK5CYII=",palette:null}},931:function(e,t,a){"use strict";a.r(t),a.d(t,{frontMatter:function(){return m},contentTitle:function(){return w},metadata:function(){return f},assets:function(){return k},toc:function(){return b},default:function(){return y}});var p=a(7462),i=a(3366),n=(a(7294),a(4137)),s=a(5944),o=a(7126),r=a.n(o),h=a(5301),l=a.n(h),A=a(2458),c=a.n(A),u=a(7471),d=a.n(u),g=["components"],m={slug:"puppet-whatsapp-1.0-released",title:"Puppet-Whatsapp 1.0 Released!",authors:"windmemory",tags:["wechaty","whatsapp"],keywords:["wechaty","puppet-whatsapp","wechaty-puppet","whatsapp","wechaty-1.0"]},w=void 0,f={permalink:"/puppet-whatsapp-1.0-released",editUrl:"https://github.com/juzibot/tech-blog/blog/2022-03-14-puppet-whatsapp-1.0-released.mdx",source:"@site/blog/2022-03-14-puppet-whatsapp-1.0-released.mdx",title:"Puppet-Whatsapp 1.0 Released!",description:"Puppet-Whatsapp has been published for more than a year, (announcement here), and it was still in alpha stage with only login and text message supported. Recently Juzi.bot was planning to support whatsapp in the web application, so we started working on the project.",date:"2022-03-14T00:00:00.000Z",formattedDate:"March 14, 2022",tags:[{label:"wechaty",permalink:"/tags/wechaty"},{label:"whatsapp",permalink:"/tags/whatsapp"}],readingTime:3.785,truncated:!0,authors:[{name:"Yuan Gao",title:"CTO of Juzi Bot",url:"https://github.com/windmemory",imageURL:"https://github.com/windmemory.png",key:"windmemory"}],frontMatter:{slug:"puppet-whatsapp-1.0-released",title:"Puppet-Whatsapp 1.0 Released!",authors:"windmemory",tags:["wechaty","whatsapp"],keywords:["wechaty","puppet-whatsapp","wechaty-puppet","whatsapp","wechaty-1.0"]},nextItem:{title:"Why developer interview cares about algorithm?",permalink:"/algorithm-interview"}},k={authorsImageUrls:[void 0]},b=[{value:"Primary Goals",id:"primary-goals",level:2},{value:"Improve code structure",id:"improve-code-structure",level:2},{value:"Improve stability",id:"improve-stability",level:2},{value:"Login Session",id:"login-session",level:3},{value:"Request Control",id:"request-control",level:3},{value:"Request Manager",id:"request-manager",level:4},{value:"Cache Manager",id:"cache-manager",level:4},{value:"Improve functionality",id:"improve-functionality",level:2},{value:"Thanks To",id:"thanks-to",level:2},{value:"New PuppetWhatsapp Maintainers",id:"new-puppetwhatsapp-maintainers",level:3},{value:"Reference",id:"reference",level:2}],C={toc:b};function y(e){var t=e.components,a=(0,i.Z)(e,g);return(0,n.kt)("wrapper",(0,p.Z)({},C,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("p",null,(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whstsapp"},(0,n.kt)("inlineCode",{parentName:"a"},"Puppet-Whatsapp"))," has been published for more than a year, (",(0,n.kt)("a",{parentName:"p",href:"https://wechaty.js.org/2021/02/15/publishment-of-wechaty-whatsapp-puppet/"},"announcement here"),"), and it was still in alpha stage with only login and text message supported. Recently ",(0,n.kt)("a",{parentName:"p",href:"https://juzibot.com"},"Juzi.bot")," was planning to support whatsapp in the web application, so we started working on the project."),(0,n.kt)(s.Z,{img:r(),mdxType:"Image"}),(0,n.kt)("h2",{id:"primary-goals"},"Primary Goals"),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},(0,n.kt)("em",{parentName:"strong"},"Make puppet-whatsapp to be enterprise beta ready"))),(0,n.kt)("p",null,"To achieve this goal, we worked from below aspects:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},"improve code structure"),(0,n.kt)("li",{parentName:"ul"},"improve stability"),(0,n.kt)("li",{parentName:"ul"},"improve functionality")),(0,n.kt)("h2",{id:"improve-code-structure"},"Improve code structure"),(0,n.kt)("p",null,"Code structure is also related to the application structure. Before we started, we looked into the code, and found that all the main code logic are written into a huge class called ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp"),". This is okay for an alpha stage puppet, but the scalability and flexibility will be limited by the structure. To make sure we have an enterprise beta ready puppet, we need to have a better foundation. Based on the experience working on other puppets, we extract below components from the huge class:"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/whatsapp/whatsapp-manager.ts"},(0,n.kt)("inlineCode",{parentName:"a"},"WhatsappManager")),": in charge of everything that connects to ",(0,n.kt)("inlineCode",{parentName:"li"},"whatsapp-web.js")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/tree/main/src/puppet-mixin"},"'mixins'"),": separate implementation of different entities' into different mixins")),(0,n.kt)("p",null,"Besides, we also added a new manager layer to the ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp"),". With a new ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetManager"),", we are able to make the ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp")," class with least logic, and most code are pretty short and easy to read."),(0,n.kt)("h2",{id:"improve-stability"},"Improve stability"),(0,n.kt)("p",null,"Stability is really important for an enterprise ready puppet."),(0,n.kt)("h3",{id:"login-session"},"Login Session"),(0,n.kt)("p",null,"The first step for stability project of a puppet is always keep the login session. Two advantage with an persistent login session:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"easier for develop phase, since restart application won't require a new scan login"),(0,n.kt)("li",{parentName:"ol"},"easier to maintain stability, when we encounter an unknown state that causes application hangs or crashes, we could confidently restart the application and automatically re-login, recover the application with minor down time")),(0,n.kt)("p",null,"So we spent a lot of time working on the login session. We've also found some issues in ",(0,n.kt)("inlineCode",{parentName:"p"},"whatsapp-web.js")," project. To make sure we could finish ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp")," within a reasonable time, we decide to fork the ",(0,n.kt)("inlineCode",{parentName:"p"},"whatsapp-web.js")," and fix the problem,\nthen raise PRs to ",(0,n.kt)("inlineCode",{parentName:"p"},"whatsapp-web.js")," project."),(0,n.kt)("h3",{id:"request-control"},"Request Control"),(0,n.kt)("p",null,(0,n.kt)("inlineCode",{parentName:"p"},"whatsapp-web.js")," is using the ",(0,n.kt)("inlineCode",{parentName:"p"},"puppeteer")," to control the whatsapp web application, so the api calling rate and amount needs to be considered, if we are making requests too frequent, the ",(0,n.kt)("inlineCode",{parentName:"p"},"puppeteer")," might crash, if we are making too many requests, we might trigger the risk control mechanism of whatsapp. So request control is another key point to ensure stability."),(0,n.kt)("p",null,"To control the request sent to whatsapp application, there are two different ways, both are important:"),(0,n.kt)("ol",null,(0,n.kt)("li",{parentName:"ol"},"programmatically limit the request rate"),(0,n.kt)("li",{parentName:"ol"},"use cache to reduce the get requests to whatsapp")),(0,n.kt)("h4",{id:"request-manager"},"Request Manager"),(0,n.kt)("p",null,"We created a new class called ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/request/request-manager.ts"},(0,n.kt)("inlineCode",{parentName:"a"},"RequestManager"))," to handle all request related stuff, and within the ",(0,n.kt)("inlineCode",{parentName:"p"},"RequestManager"),", we added another component called ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/request/rate-manager.ts"},(0,n.kt)("inlineCode",{parentName:"a"},"RateManager")),". For detailed code changes, please refer to ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whatsapp/pull/279"},"this PR")),(0,n.kt)("h4",{id:"cache-manager"},"Cache Manager"),(0,n.kt)("p",null,"We created a new class called ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/data/cache-manager.ts'"},(0,n.kt)("inlineCode",{parentName:"a"},"CacheManager"))," to manager different caches. We use ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/huan/flash-store"},(0,n.kt)("inlineCode",{parentName:"a"},"flash-store"))," as the underlying data persistent library, which is actually an old friend of puppets. "),(0,n.kt)("p",null,"With ",(0,n.kt)("inlineCode",{parentName:"p"},"CacheManager"),", requests to get same contact or room will be served by cache, from previous experience, this will significant reduce the get requests to IMs."),(0,n.kt)("h2",{id:"improve-functionality"},"Improve functionality"),(0,n.kt)("p",null,"The alpha version only supports login and text messages, which is too basic for an enterprise ready puppet. So we started to add more features to the ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp"),"."),(0,n.kt)("p",null,"Refer to new Wechaty 1.0 mixin design, we decide to also use mixins to implement the new functions. We've added 7 mixins"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/contact-self.ts"},"contact-self")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/contact.ts"},"contact")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/conversation.ts"},"conversation")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/friendship.ts"},"friendship")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/message.ts"},"message")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/room.ts"},"room")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wechaty/puppet-whatsapp/blob/9d9db5d308e253d92dae085f32e9b4ffea6fac3f/src/puppet-mixin/tag.ts"},"tag"))),(0,n.kt)("p",null,"Some of the mixin has only un-implemented methods, but they are placeholders for future implementations."),(0,n.kt)("h2",{id:"thanks-to"},"Thanks To"),(0,n.kt)("p",null,"With all works described above, we've glad to announce ",(0,n.kt)("strong",{parentName:"p"},(0,n.kt)("em",{parentName:"strong"},(0,n.kt)("u",null,"the ",(0,n.kt)("inlineCode",{parentName:"em"},"PuppetWhatsapp")," Beta are launched!")))),(0,n.kt)(s.Z,{img:c(),mdxType:"Image"}),(0,n.kt)("p",null,"Thanks to developers contributing to the project"),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/su-chang"},"SuperChang")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/hcfw007"},"NickWang")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/bung87"},"Bung")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/wedreamer"},"\u8ff0\u4e0d\u4f5c")),(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("a",{parentName:"li",href:"https://github.com/guo40020"},"Kelly"))),(0,n.kt)(s.Z,{img:l(),mdxType:"Image"}),(0,n.kt)("h3",{id:"new-puppetwhatsapp-maintainers"},"New PuppetWhatsapp Maintainers"),(0,n.kt)("p",null,"To award the excellent contribution to ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp"),", author of Wechaty, ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/huan"},"Huan"),", announced two new ",(0,n.kt)("inlineCode",{parentName:"p"},"PuppetWhatsapp")," maintainers, they are ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/su-chang"},"SuperChang")," and ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/hcfw007"},"NickWang"),". And a Github T-shirt, a bag of Github stickers and a Github brooch were given as the maintainer gifts. Additionally, to reward ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/su-chang"},"SuperChang"),"'s continuous contribution to Wechaty, a special edition Github cup was rewarded."),(0,n.kt)(s.Z,{img:d(),mdxType:"Image"}),(0,n.kt)("h2",{id:"reference"},"Reference"),(0,n.kt)("blockquote",null,(0,n.kt)("p",{parentName:"blockquote"},"Code base: ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whatsapp"},"https://github.com/wechaty/puppet-whatsapp")),(0,n.kt)("p",{parentName:"blockquote"},"Main Issue: ",(0,n.kt)("a",{parentName:"p",href:"https://github.com/wechaty/puppet-whatsapp/issues/263"},"https://github.com/wechaty/puppet-whatsapp/issues/263"))))}y.isMDXComponent=!0}}]);